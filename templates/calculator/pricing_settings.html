{% extends "calculator/base.html" %}
{% block title %}تنظیمات قیمت‌گذاری{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-4">
  <div class="hero-card mb-4">
    <div class="hero-bg"></div>
    <div class="hero-content">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-2">
          <span class="hero-icon"><i class="fas fa-sliders-h"></i></span>
          <div>
            <h1 class="hero-title mb-0">تنظیمات قیمت‌گذاری</h1>
            <div class="hero-subtitle mt-1">قیمت برق، درصد سود، استهلاک و سرویس‌ها را مدیریت کنید</div>
          </div>
        </div>
        <div class="text-muted small">
          آخرین بروزرسانی: {{ settings_obj.updated_at|date:"Y/m/d H:i" }}
        </div>
      </div>
    </div>
  </div>

  {% if messages %}
  <div class="mb-3">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <form method="post" class="row g-4" novalidate>
    {% csrf_token %}

    <div class="col-12 col-xl-8">
      <div class="card neo-card">
        <div class="card-header border-0">
          <h5 class="mb-0"><i class="fas fa-bolt me-2 text-warning"></i>هزینه‌های پایه</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">قیمت برق (تومان/کیلووات‌ساعت)</label>
              {{ form.power_price_per_kwh }}
              {% for e in form.power_price_per_kwh.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">استهلاک دستگاه (تومان/ساعت)</label>
              {{ form.depreciation_per_hour }}
              {% for e in form.depreciation_per_hour.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">درصد پرت فیلامنت (%)</label>
              {{ form.filament_waste_percent }}
              {% for e in form.filament_waste_percent.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">هزینه بسته‌بندی (تومان)</label>
              {{ form.packaging_cost }}
              {% for e in form.packaging_cost.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="card neo-card mt-4">
        <div class="card-header border-0">
          <h5 class="mb-0"><i class="fas fa-tools me-2 text-info"></i>خدمات</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">نرخ پست‌پروسسینگ (تومان)</label>
              {{ form.post_processing_rate }}
              {% for e in form.post_processing_rate.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">نرخ رنگ‌آمیزی (تومان/سانتی‌متر مربع)</label>
              {{ form.painting_rate_per_cm2 }}
              {% for e in form.painting_rate_per_cm2.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="card neo-card mt-4">
        <div class="card-header border-0">
          <h5 class="mb-0"><i class="fas fa-percentage me-2 text-success"></i>سیاست قیمت‌گذاری</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">درصد سود (%)</label>
              {{ form.profit_percent }}
              {% for e in form.profit_percent.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
            <div class="col-md-6">
              <label class="form-label">گرد کردن قیمت (تومان)</label>
              {{ form.round_to_nearest }}
              {% for e in form.round_to_nearest.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="card neo-card mt-4">
        <div class="card-body d-flex align-items-center justify-content-between gap-3 flex-wrap">
          <div class="form-check m-0">
            <input class="form-check-input" type="checkbox" id="confirm_apply" name="confirm_apply">
            <label class="form-check-label" for="confirm_apply">تایید اعمال تغییرات</label>
          </div>
          <div class="d-flex gap-2 ms-auto">
            <a href="{% url 'calculator:pricing_settings' %}" class="btn btn-outline-secondary">
              <i class="fas fa-undo me-1"></i> لغو تغییرات
            </a>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save me-1"></i> ذخیره تنظیمات
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <div class="card neo-card sticky-top" style="top: 90px;">
        <div class="card-header border-0">
          <h6 class="mb-0"><i class="fas fa-eye me-2 text-primary"></i>پیش‌نمایش سریع</h6>
        </div>
        <div class="card-body">
          <ul class="list-unstyled mb-0">
            <li class="d-flex justify-content-between py-2 border-bottom">
              <span><i class="fas fa-bolt me-2 text-warning"></i>قیمت برق</span>
              <strong>{{ form.power_price_per_kwh.value|default:settings_obj.power_price_per_kwh }} ت</strong>
            </li>
            <li class="d-flex justify-content-between py-2 border-bottom">
              <span><i class="fas fa-tools me-2 text-secondary"></i>استهلاک</span>
              <strong>{{ form.depreciation_per_hour.value|default:settings_obj.depreciation_per_hour }} ت/س</strong>
            </li>
            <li class="d-flex justify-content-between py-2 border-bottom">
              <span><i class="fas fa-box-open me-2 text-info"></i>بسته‌بندی</span>
              <strong>{{ form.packaging_cost.value|default:settings_obj.packaging_cost }} ت</strong>
            </li>
            <li class="d-flex justify-content-between py-2 border-bottom">
              <span><i class="fas fa-hammer me-2 text-info"></i>پست‌پروسسینگ</span>
              <strong>{{ form.post_processing_rate.value|default:settings_obj.post_processing_rate }} ت</strong>
            </li>
            <li class="d-flex justify-content-between py-2 border-bottom">
              <span><i class="fas fa-palette me-2 text-danger"></i>رنگ‌آمیزی</span>
              <strong>{{ form.painting_rate_per_cm2.value|default:settings_obj.painting_rate_per_cm2 }} ت/سانتی‌متر²</strong>
            </li>
            <li class="d-flex justify-content-between py-2">
              <span><i class="fas fa-percentage me-2 text-success"></i>سود</span>
              <strong>{{ form.profit_percent.value|default:settings_obj.profit_percent }}%</strong>
            </li>
          </ul>
          <div class="alert alert-info-soft mt-3 mb-0">
            <i class="fas fa-info-circle me-2"></i>
            این تنظیمات در محاسبات صفحه افزودن مدل به صورت زنده استفاده می‌شود.
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<style>
.hero-card{position:relative;border-radius:16px;overflow:hidden;padding:18px;background:rgba(255,255,255,.6);backdrop-filter:blur(6px);border:1px solid rgba(0,0,0,.06)}
.hero-bg{position:absolute;inset:0;background:radial-gradient(1200px 400px at 100% -10%,rgba(32,201,151,.10),transparent),radial-gradient(600px 300px at -10% 120%,rgba(13,110,253,.10),transparent)}
.hero-content{position:relative;z-index:1}
.hero-icon{display:inline-flex;width:40px;height:40px;border-radius:10px;align-items:center;justify-content:center;background:linear-gradient(135deg,#0d6efd,#20c997);color:#fff;box-shadow:0 6px 14px rgba(13,110,253,.25)}
.hero-title{font-size:1.3rem;font-weight:800}.hero-subtitle{color:#5f6b7a}
.neo-card{border:1px solid #e9ecef;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden}
.alert-info-soft{background:rgba(13,110,253,.08);border:1px solid rgba(13,110,253,.18)}
@media (max-width: 991.98px){.hero-title{font-size:1.15rem}}
</style>
{% endblock %}