<!-- templates/calculator/reports.html -->
{% extends "calculator/base.html" %}

{% block title %}گزارشات فروش{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-4">
    <!-- Modern Hero Section -->
    <div class="modern-hero-card mb-4">
        <div class="hero-background"></div>
        <div class="hero-content">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                <div class="d-flex align-items-center gap-2">
                    <span class="hero-icon-modern"><i class="fas fa-chart-bar"></i></span>
                    <div>
                        <h1 class="hero-title-modern mb-0">گزارش‌ها و آمار</h1>
                        <div class="hero-subtitle-modern mt-1">تحلیل جامع عملکرد کسب‌وکار پرینت سه‌بعدی</div>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge-modern badge-primary">
                        <i class="fas fa-calendar me-1"></i>{{ period_name|default:"همه زمان‌ها" }}
                    </span>
                    <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>چاپ گزارش
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card modern-card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i>فیلتر گزارشات</h5>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">
                        <i class="fas fa-calendar-alt me-2"></i>بازه زمانی
                    </label>
                    <select name="period" class="form-select">
                        <option value="week" {% if period == 'week' %}selected{% endif %}>هفته گذشته</option>
                        <option value="month" {% if period == 'month' %}selected{% endif %}>ماه گذشته</option>
                        <option value="year" {% if period == 'year' %}selected{% endif %}>سال گذشته</option>
                        <option value="all" {% if period == 'all' or not period %}selected{% endif %}>همه زمان‌ها</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">
                        <i class="fas fa-search me-2"></i>جستجو در نام محصول
                    </label>
                    <input type="text" name="item_filter" class="form-control" 
                           value="{{ item_filter|default:'' }}" placeholder="نام محصول...">
                </div>
                <div class="col-md-2">
                    <label class="form-label">
                        <i class="fas fa-sort me-2"></i>مرتب‌سازی
                    </label>
                    <select name="sort" class="form-select">
                        <option value="-sale_date" {% if sort == "-sale_date" or not sort %}selected{% endif %}>جدیدترین</option>
                        <option value="sale_date" {% if sort == "sale_date" %}selected{% endif %}>قدیمی‌ترین</option>
                        <option value="-total_price" {% if sort == "-total_price" %}selected{% endif %}>بیشترین مبلغ</option>
                        <option value="total_price" {% if sort == "total_price" %}selected{% endif %}>کمترین مبلغ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>اعمال فیلتر
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row g-3 mb-4">
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="metric-card metric-info">
                <div class="metric-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">{{ total_sales|default:0 }}</div>
                    <div class="metric-label">کل فروش</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="metric-card metric-success">
                <div class="metric-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">{{ total_revenue|default:0|floatformat:0 }}</div>
                    <div class="metric-label">درآمد کل</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="metric-card metric-warning">
                <div class="metric-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">{{ total_production_cost|default:0|floatformat:0 }}</div>
                    <div class="metric-label">هزینه تولید</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="metric-card metric-secondary">
                <div class="metric-icon">
                    <i class="fas fa-box"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">{{ total_packaging_cost|default:0|floatformat:0 }}</div>
                    <div class="metric-label">هزینه بسته‌بندی</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="metric-card metric-danger">
                <div class="metric-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">{{ total_cost|default:0|floatformat:0 }}</div>
                    <div class="metric-label">کل هزینه‌ها</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6">
            <div class="metric-card metric-primary">
                <div class="metric-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-content">
                    <div class="metric-value">{{ total_profit|default:0|floatformat:0 }}</div>
                    <div class="metric-label">سود خالص</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row g-4">
        <!-- Sales Details -->
        <div class="col-xl-9">
            <div class="card modern-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>جزئیات فروش - {{ period_name|default:"همه زمان‌ها" }}</h5>
                    <span class="badge bg-primary fs-6">{{ total_sales|default:0 }} فروش</span>
                </div>
                <div class="card-body p-0">
                    {% if sales_data and sales_data|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="px-3 py-3"><i class="fas fa-hashtag me-1"></i>کد</th>
                                        <th class="py-3"><i class="fas fa-image me-1"></i>تصویر</th>
                                        <th class="py-3"><i class="fas fa-cube me-1"></i>محصول</th>
                                        <th class="py-3"><i class="fas fa-sort-numeric-up me-1"></i>تعداد</th>
                                        <th class="py-3"><i class="fas fa-tag me-1"></i>قیمت واحد</th>
                                        <th class="py-3"><i class="fas fa-box me-1"></i>بسته‌بندی</th>
                                        <th class="py-3"><i class="fas fa-money-bill me-1"></i>قیمت کل</th>
                                        <th class="py-3"><i class="fas fa-calculator me-1"></i>هزینه تولید</th>
                                        <th class="py-3"><i class="fas fa-chart-line me-1"></i>سود</th>
                                        <th class="py-3"><i class="fas fa-user me-1"></i>مشتری</th>
                                        <th class="py-3"><i class="fas fa-calendar me-1"></i>تاریخ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for sale in sales_data %}
                                    <tr class="sales-row">
                                        <td class="px-3 py-3">
                                            <span class="badge bg-primary">{{ sale.project.code|default:"N/A" }}</span>
                                        </td>
                                        <td class="py-3">
                                            {% if sale.project.picture %}
                                                <img src="{{ sale.project.picture.url }}" alt="{{ sale.project.model_name }}" 
                                                     class="rounded shadow-sm project-thumbnail" 
                                                     style="width: 50px; height: 50px; object-fit: cover;">
                                            {% else %}
                                                <div class="bg-light rounded d-flex align-items-center justify-content-center shadow-sm" 
                                                     style="width: 50px; height: 50px;">
                                                    <i class="fas fa-cube text-muted"></i>
                                                </div>
                                            {% endif %}
                                        </td>
                                        <td class="py-3">
                                            <div class="product-info">
                                                <strong class="d-block">{{ sale.project.model_name|default:'نامشخص' }}</strong>
                                                <small class="text-muted">
                                                    {{ sale.project.filament.name|default:'نامشخص' }} - {{ sale.project.filament.color|default:'' }}
                                                </small>
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <span class="badge bg-info fs-6">{{ sale.quantity|default:1 }} عدد</span>
                                        </td>
                                        <td class="py-3">
                                            <div class="price-info">
                                                <span class="text-primary fw-bold">{{ sale.unit_price|default:0|floatformat:0 }}</span>
                                                <small class="text-muted d-block">تومان</small>
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            {% if sale.packaging_cost and sale.packaging_cost > 0 %}
                                                <div class="price-info">
                                                    <span class="text-secondary">{{ sale.packaging_cost|floatformat:0 }}</span>
                                                    <small class="text-muted d-block">تومان</small>
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="py-3">
                                            <div class="price-info">
                                                <span class="text-success fw-bold">{{ sale.final_price|default:sale.total_price|default:0|floatformat:0 }}</span>
                                                <small class="text-muted d-block">تومان</small>
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <div class="price-info">
                                                {% with production_cost=sale.project.total_cost|default:0 %}
                                                    {% with total_production=production_cost|add:0 %}
                                                        <span class="text-warning">{{ total_production|floatformat:0 }}</span>
                                                        <small class="text-muted d-block">تومان</small>
                                                    {% endwith %}
                                                {% endwith %}
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <div class="price-info">
                                                {% with sale_total=sale.final_price|default:sale.total_price|default:0 %}
                                                    {% with production_cost=sale.project.total_cost|default:0 %}
                                                        {% with profit=sale_total|add:production_cost|add:0 %}
                                                            <span class="{% if profit > 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                                                                {{ sale.total_profit|default:profit|floatformat:0 }}
                                                            </span>
                                                            <small class="text-muted d-block">تومان</small>
                                                        {% endwith %}
                                                    {% endwith %}
                                                {% endwith %}
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            {% if sale.customer_name %}
                                                <div class="customer-info">
                                                    <strong class="d-block">{{ sale.customer_name }}</strong>
                                                    {% if sale.customer_phone %}
                                                        <small class="text-muted">{{ sale.customer_phone }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">ناشناس</span>
                                            {% endif %}
                                        </td>
                                        <td class="py-3">
                                            <div class="date-info">
                                                <span class="d-block">{{ sale.sale_date|date:"Y/m/d"|default:"نامشخص" }}</span>
                                                <small class="text-muted">{{ sale.sale_date|time:"H:i"|default:"" }}</small>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Summary Row -->
                        <div class="card-footer">
                            <div class="row g-3 text-center">
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <h6 class="text-muted mb-1">کل فروش</h6>
                                        <h5 class="text-primary mb-0">{{ total_sales|default:0 }} مورد</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <h6 class="text-muted mb-1">کل درآمد</h6>
                                        <h5 class="text-success mb-0">{{ total_revenue|default:0|floatformat:0 }} تومان</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <h6 class="text-muted mb-1">کل هزینه</h6>
                                        <h5 class="text-warning mb-0">{{ total_cost|default:0|floatformat:0 }} تومان</h5>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="summary-item">
                                        <h6 class="text-muted mb-1">سود خالص</h6>
                                        <h5 class="{% if total_profit|default:0 > 0 %}text-success{% else %}text-danger{% endif %} mb-0">
                                            {{ total_profit|default:0|floatformat:0 }} تومان
                                        </h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <!-- Empty State -->
                        <div class="empty-state-large">
                            <div class="empty-icon">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <h3 class="empty-title">
                                {% if item_filter %}
                                    نتیجه‌ای یافت نشد
                                {% else %}
                                    هیچ فروشی در این بازه زمانی یافت نشد
                                {% endif %}
                            </h3>
                            <p class="empty-text">
                                {% if item_filter %}
                                    فیلتر جستجو را تغییر دهید یا فیلترها را حذف کنید
                                {% else %}
                                    فیلترهای مختلف را امتحان کنید یا فروش جدیدی ثبت کنید
                                {% endif %}
                            </p>
                            <div class="empty-actions">
                                {% if item_filter %}
                                    <a href="{% url 'calculator:reports' %}" class="btn btn-primary">
                                        <i class="fas fa-times me-2"></i>حذف فیلترها
                                    </a>
                                {% else %}
                                    <a href="{% url 'calculator:sales' %}" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>ثبت فروش جدید
                                    </a>
                                {% endif %}
                                <a href="{% url 'calculator:index' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-home me-2"></i>بازگشت به داشبورد
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-xl-3">
            <!-- Top Products -->
            <div class="card modern-card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-trophy me-2"></i>محصولات پرفروش</h6>
                </div>
                <div class="card-body">
                    {% if top_products and top_products|length > 0 %}
                        <div class="products-list">
                            {% for product in top_products %}
                            <div class="product-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 flex-grow-1 me-2">{{ product.project__model_name|default:"نامشخص" }}</h6>
                                    <span class="badge bg-primary flex-shrink-0">{{ product.count|default:0 }}</span>
                                </div>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <small class="text-muted d-block mb-1">تعداد فروش</small>
                                        <strong class="text-info">{{ product.total_quantity|default:0 }} عدد</strong>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted d-block mb-1">درآمد</small>
                                        <strong class="text-success">{{ product.revenue|default:0|floatformat:0 }}</strong>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                            <p class="text-muted mb-0">داده‌ای موجود نیست</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit form when period changes
    const periodSelect = document.querySelector('select[name="period"]');
    if (periodSelect) {
        periodSelect.addEventListener('change', function() {
            this.form.submit();
        });
    }

    // Format numbers in metric cards
    const metricValues = document.querySelectorAll('.metric-value');
    metricValues.forEach(element => {
        const value = parseFloat(element.textContent.replace(/[^\d.-]/g, ''));
        if (!isNaN(value) && value !== 0) {
            element.textContent = value.toLocaleString('fa-IR');
        }
    });

    // Add hover effects to table rows
    const tableRows = document.querySelectorAll('.sales-row');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = 'var(--primary-50)';
            this.style.transform = 'scale(1.005)';
            this.style.transition = 'all 0.2s ease';
        });

        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.transform = '';
        });
    });

    // Enhanced thumbnail hover
    const thumbnails = document.querySelectorAll('.project-thumbnail');
    thumbnails.forEach(thumb => {
        thumb.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
            this.style.transition = 'transform 0.3s ease';
        });
        thumb.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
});
</script>

<style>
/* Modern Hero */
.modern-hero-card {
    position: relative;
    border-radius: var(--border-radius-xl);
    overflow: hidden;
    padding: var(--spacing-xl);
    background: rgba(255,255,255,0.7);
    backdrop-filter: blur(20px);
    border: 1px solid var(--primary-200);
    box-shadow: var(--shadow-lg);
}
.hero-background {
    position: absolute; inset: 0;
    background: radial-gradient(1200px 400px at 100% -10%, var(--success-100), transparent),
                radial-gradient(600px 300px at -10% 120%, var(--primary-100), transparent);
    pointer-events: none;
}
.hero-content { position: relative; z-index: 1; }
.hero-icon-modern {
    display: inline-flex; width: 40px; height: 40px;
    border-radius: var(--border-radius-md); align-items: center; justify-content: center;
    background: linear-gradient(135deg, var(--primary-500), var(--success-500)); 
    color: #fff;
    box-shadow: var(--shadow-md);
}
.hero-title-modern { font-size: 1.4rem; font-weight: 800; color: var(--secondary-800); }
.hero-subtitle-modern { color: var(--secondary-600); font-size: .95rem; }

/* Modern Badges */
.badge-modern {
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--border-radius-sm);
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}
.badge-primary { background: var(--primary-500); color: white; }

/* Modern Cards */
.modern-card {
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(20px);
    border: 1px solid var(--primary-200);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
}

/* Metric Cards */
.metric-card {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px);
    border-radius: var(--border-radius-xl);
    padding: 1.5rem;
    border: 1px solid var(--secondary-200);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
    min-height: 120px;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-xl);
}

.metric-primary { border-left: 4px solid var(--primary-500); }
.metric-success { border-left: 4px solid var(--success-500); }
.metric-warning { border-left: 4px solid var(--warning-500); }
.metric-info { border-left: 4px solid var(--info-500); }
.metric-danger { border-left: 4px solid var(--danger-500); }
.metric-secondary { border-left: 4px solid var(--secondary-500); }

.metric-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--border-radius-lg);
    font-size: 1.25rem;
    color: white;
}

.metric-primary .metric-icon { background: var(--primary-500); }
.metric-success .metric-icon { background: var(--success-500); }
.metric-warning .metric-icon { background: var(--warning-500); }
.metric-info .metric-icon { background: var(--info-500); }
.metric-danger .metric-icon { background: var(--danger-500); }
.metric-secondary .metric-icon { background: var(--secondary-500); }

.metric-content {
    flex: 1;
}

.metric-value {
    font-size: 1.75rem;
    font-weight: 800;
    color: var(--secondary-800);
    line-height: 1;
}

.metric-label {
    color: var(--secondary-600);
    font-size: 0.9rem;
    margin-top: 0.25rem;
}

/* Table Enhancements */
.table {
    font-size: 0.875rem;
}

.table th {
    font-weight: 600;
    white-space: nowrap;
    border-bottom: 2px solid var(--secondary-200);
    font-size: 0.8rem;
    background: var(--surface-50);
}

.table td {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
}

.sales-row {
    transition: all 0.2s ease;
}

/* Info Sections */
.product-info,
.price-info,
.customer-info,
.date-info {
    min-width: 0;
}

.product-info strong {
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.price-info {
    text-align: right;
}

.customer-info strong {
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.date-info {
    text-align: center;
    min-width: 80px;
}

/* Summary Items */
.summary-item {
    padding: 1rem;
    border-radius: var(--border-radius-lg);
    background: var(--surface-50);
    transition: all 0.3s ease;
}

.summary-item:hover {
    background: var(--primary-50);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

/* Product Items */
.product-item {
    padding: 1rem;
    border-radius: var(--border-radius-lg);
    background: var(--surface-50);
    border: 1px solid var(--secondary-200);
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.product-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
    background: var(--primary-50);
    border-color: var(--primary-300);
}

/* Quick Stats */
.quick-stats {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.quick-stat-item {
    padding: 0.75rem;
    border-radius: var(--border-radius-md);
    background: var(--surface-50);
    border: 1px solid var(--secondary-200);
    transition: all 0.3s ease;
}

.quick-stat-item:hover {
    background: var(--primary-50);
    border-color: var(--primary-300);
}

/* Empty State */
.empty-state-large {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--secondary-500);
}

.empty-icon {
    font-size: 5rem;
    color: var(--secondary-300);
    margin-bottom: 1.5rem;
}

.empty-title {
    color: var(--secondary-700);
    margin-bottom: 1rem;
}

.empty-text {
    font-size: 1.1rem;
    margin-bottom: 2rem;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.empty-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

/* Responsive */
@media (max-width: 767.98px) {
    .hero-title-modern { font-size: 1.2rem; }
    .metric-card { padding: 1rem; min-height: 100px; }
    .metric-value { font-size: 1.5rem; }
    .metric-icon { width: 40px; height: 40px; font-size: 1rem; }
    .table { font-size: 0.8rem; }
    .table th, .table td { padding: 0.5rem 0.25rem; }
    .empty-state-large { padding: 2rem 1rem; }
    .empty-actions { flex-direction: column; align-items: center; }
}

@media print {
    .modern-hero-card, .card { 
        box-shadow: none !important; 
        border: 1px solid #ddd !important;
    }
    .btn { display: none !important; }
}
</style>
{% endblock %}