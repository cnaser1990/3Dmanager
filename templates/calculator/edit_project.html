<!-- templates/calculator/edit_project.html -->
{% extends "calculator/base.html" %}

{% block title %}ویرایش مدل{% endblock %}

{% block content %}
<div class="container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="container">
            <h1 class="page-title">
                <i class="fas fa-edit me-3"></i>
                ویرایش مدل
            </h1>
            <p class="page-subtitle">{{ project.model_name }} - {{ project.filament.name }} {{ project.filament.color }}</p>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card fade-in">
                <div class="card-header">
                    <h5>
                        <i class="fas fa-edit me-2"></i>
                        ویرایش اطلاعات مدل
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="projectForm">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-4">
                                    <label for="{{ form.model_name.id_for_label }}" class="form-label">
                                        <i class="fas fa-cube me-2 text-primary"></i>نام مدل
                                    </label>
                                    {{ form.model_name }}
                                    {% if form.model_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.model_name.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label for="{{ form.picture.id_for_label }}" class="form-label">
                                        <i class="fas fa-camera me-2 text-success"></i>تصویر مدل
                                    </label>
                                    {{ form.picture }}
                                    {% if project.has_image %}
                                        <div class="mt-3">
                                            <img src="{{ project.picture.url }}" alt="{{ project.model_name }}" 
                                                 class="img-thumbnail project-image" style="max-height: 120px;">
                                            <br><small class="text-muted">تصویر فعلی</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Image Preview -->
                        <div id="imagePreview" class="mb-4" style="display: none;">
                            <div class="text-center">
                                <img id="previewImg" src="" alt="پیش‌نمایش" 
                                     class="img-thumbnail project-image" style="max-height: 200px;">
                                <br>
                                <small class="text-muted">پیش‌نمایش تصویر جدید</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="{{ form.filament_used_mm.id_for_label }}" class="form-label">
                                        <i class="fas fa-ruler me-2 text-info"></i>فیلامنت مصرفی (میلی‌متر)
                                    </label>
                                    {{ form.filament_used_mm }}
                                    {% if form.filament_used_mm.errors %}
                                        <div class="text-danger small mt-1">{{ form.filament_used_mm.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        هر 1000mm = 1m
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="{{ form.print_time_hours.id_for_label }}" class="form-label">
                                        <i class="fas fa-clock me-2 text-warning"></i>زمان پرینت (ساعت)
                                    </label>
                                    {{ form.print_time_hours }}
                                    {% if form.print_time_hours.errors %}
                                        <div class="text-danger small mt-1">{{ form.print_time_hours.errors.0 }}</div>
                                    {% endif %}
                                    <div class="form-text">
                                        <i class="fas fa-info-circle me-1"></i>
                                        مثال: 3.5
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label for="{{ form.size_x.id_for_label }}" class="form-label">
                                        <i class="fas fa-arrows-alt-h me-2 text-danger"></i>ابعاد X (میلی‌متر)
                                    </label>
                                    {{ form.size_x }}
                                    {% if form.size_x.errors %}
                                        <div class="text-danger small mt-1">{{ form.size_x.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label for="{{ form.size_y.id_for_label }}" class="form-label">
                                        <i class="fas fa-arrows-alt-v me-2 text-danger"></i>ابعاد Y (میلی‌متر)
                                    </label>
                                    {{ form.size_y }}
                                    {% if form.size_y.errors %}
                                        <div class="text-danger small mt-1">{{ form.size_y.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-4">
                                    <label for="{{ form.size_z.id_for_label }}" class="form-label">
                                        <i class="fas fa-arrows-alt me-2 text-danger"></i>ابعاد Z (میلی‌متر)
                                    </label>
                                    {{ form.size_z }}
                                    {% if form.size_z.errors %}
                                        <div class="text-danger small mt-1">{{ form.size_z.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Additional Services -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <div class="form-check">
                                        {{ form.post_processing_enabled }}
                                        <label class="form-check-label" for="{{ form.post_processing_enabled.id_for_label }}">
                                            <i class="fas fa-hammer me-2"></i>پست‌پروسسینگ
                                        </label>
                                    </div>
                                    <small class="text-muted">پرداخت، سنباده، حذف ساپورت</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <div class="form-check">
                                        {{ form.painting_enabled }}
                                        <label class="form-check-label" for="{{ form.painting_enabled.id_for_label }}">
                                            <i class="fas fa-palette me-2"></i>رنگ‌آمیزی
                                        </label>
                                    </div>
                                    <small class="text-muted">محاسبه بر اساس حجم</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3 justify-content-end mt-4">
                            <a href="{% url 'calculator:view_filament' project.filament.pk %}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>انصراف
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-2"></i>بروزرسانی مدل
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Live Cost Preview Sidebar -->
        <div class="col-lg-4">
            <div class="sticky-top" style="top: 90px;">
                <!-- Current Info Card -->
                <div class="card mb-3" style="background: rgba(255,255,255,0.9); border: 1px solid var(--primary-200);">
                    <div class="card-header">
                        <h6><i class="fas fa-info-circle me-2"></i>اطلاعات فعلی</h6>
                    </div>
                    <div class="card-body">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-icon bg-primary">
                                    <i class="fas fa-barcode"></i>
                                </div>
                                <div class="info-details">
                                    <span class="info-label">کد مدل</span>
                                    <strong class="info-value">{{ project.code }}</strong>
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-icon bg-success">
                                    <i class="fas fa-spool"></i>
                                </div>
                                <div class="info-details">
                                    <span class="info-label">فیلامنت</span>
                                    <strong class="info-value">{{ project.filament.name }} {{ project.filament.color }}</strong>
                                </div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-icon bg-info">
                                    <i class="fas fa-calendar"></i>
                                </div>
                                <div class="info-details">
                                    <span class="info-label">تاریخ ایجاد</span>
                                    <strong class="info-value">{{ project.created_date|date:"Y/m/d" }}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Cost Preview -->
                <div class="card cost-card-modern">
                    <div class="card-header d-flex align-items-center justify-content-between" style="background: linear-gradient(135deg, var(--secondary-700), var(--secondary-800)); color: white;">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-calculator text-white"></i>
                            <h6 class="mb-0">پیش‌نمایش محاسبات</h6>
                        </div>
                        <small id="preview-status" class="text-light opacity-75">آماده محاسبه</small>
                    </div>
                    <div class="card-body" style="background: white;">
                        <div id="calc-empty" class="empty-state-modern">
                            <div class="empty-icon-modern"><i class="fas fa-info-circle"></i></div>
                            <div class="empty-text-modern">پیش‌نمایش محاسبات جدید</div>
                        </div>

                        <div id="cost-preview" class="d-none">
                            <div class="calculation-grid">
                                <div class="calc-item">
                                    <div class="calc-icon">
                                        <i class="fas fa-weight"></i>
                                    </div>
                                    <div class="calc-details">
                                        <span class="calc-label">وزن فیلامنت</span>
                                        <strong id="filament-weight" class="calc-value">0 گرم</strong>
                                    </div>
                                </div>
                                
                                <div class="calc-item">
                                    <div class="calc-icon bg-success">
                                        <i class="fas fa-spool"></i>
                                    </div>
                                    <div class="calc-details">
                                        <span class="calc-label">هزینه مواد</span>
                                        <strong id="material-cost" class="calc-value text-success">0 تومان</strong>
                                    </div>
                                </div>
                                
                                <div class="calc-item">
                                    <div class="calc-icon bg-warning">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <div class="calc-details">
                                        <span class="calc-label">هزینه برق</span>
                                        <strong id="electricity-cost" class="calc-value text-warning">0 تومان</strong>
                                    </div>
                                </div>
                                
                                <div class="calc-item">
                                    <div class="calc-icon bg-secondary">
                                        <i class="fas fa-tools"></i>
                                    </div>
                                    <div class="calc-details">
                                        <span class="calc-label">استهلاک دستگاه</span>
                                        <strong id="depreciation-cost" class="calc-value text-secondary">0 تومان</strong>
                                    </div>
                                </div>

                                <div class="calc-item d-none" id="post-processing-row">
                                    <div class="calc-icon bg-info">
                                        <i class="fas fa-hammer"></i>
                                    </div>
                                    <div class="calc-details">
                                        <span class="calc-label">پست‌پروسسینگ</span>
                                        <strong id="post-processing-cost" class="calc-value text-info">0 تومان</strong>
                                    </div>
                                </div>
                                
                                <div class="calc-item d-none" id="painting-row">
                                    <div class="calc-icon bg-danger">
                                        <i class="fas fa-palette"></i>
                                    </div>
                                    <div class="calc-details">
                                        <span class="calc-label">رنگ‌آمیزی</span>
                                        <strong id="painting-cost" class="calc-value text-danger">0 تومان</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Cost Section -->
                            <div class="total-section">
                                <div class="d-flex justify-content-between align-items-center p-3 border rounded" style="background: var(--secondary-50); border-color: var(--secondary-200) !important;">
                                    <span class="fw-bold" style="color: var(--secondary-700);">
                                        <i class="fas fa-calculator me-2"></i>کل هزینه
                                    </span>
                                    <strong id="total-cost" class="fs-5" style="color: var(--danger-600);">0 تومان</strong>
                                </div>
                            </div>

                            <!-- Selling Price Highlight -->
                            <div class="pricing-highlight-modern mt-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="label-modern">قیمت پیشنهادی فروش</div>
                                        <small id="profit-margin" class="profit-text">سود: 0 تومان</small>
                                    </div>
                                    <div class="price-modern" id="selling-price">0 تومان</div>
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <small style="color: var(--secondary-500);">محاسبات بر اساس تنظیمات پیش‌فرض انجام می‌شود</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const filamentUsed = document.getElementById('{{ form.filament_used_mm.id_for_label }}');
    const printTime = document.getElementById('{{ form.print_time_hours.id_for_label }}');
    const sizeX = document.getElementById('{{ form.size_x.id_for_label }}');
    const sizeY = document.getElementById('{{ form.size_y.id_for_label }}');
    const sizeZ = document.getElementById('{{ form.size_z.id_for_label }}');
    const postProcessing = document.getElementById('{{ form.post_processing_enabled.id_for_label }}');
    const painting = document.getElementById('{{ form.painting_enabled.id_for_label }}');

    const previewStatus = document.getElementById('preview-status');
    const costPreview = document.getElementById('cost-preview');
    const emptyState = document.getElementById('calc-empty');

    const filamentCostPerKg = {{ project.filament.cost_per_kg|default:25000 }};

    // Image preview functionality
    document.getElementById('{{ form.picture.id_for_label }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const preview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
        }
    });

    function fmt(n) {
        return new Intl.NumberFormat('fa-IR').format(Math.round(n || 0));
    }

    function hasInputs() {
        return (
            parseFloat(filamentUsed?.value || 0) > 0 &&
            parseFloat(printTime?.value || 0) > 0 &&
            parseFloat(sizeX?.value || 0) > 0 &&
            parseFloat(sizeY?.value || 0) > 0 &&
            parseFloat(sizeZ?.value || 0) > 0
        );
    }

    let isCalculating = false;

    function updateCalculationPreview() {
        if (!hasInputs()) {
            costPreview.classList.add('d-none');
            emptyState.classList.remove('d-none');
            if (previewStatus) { previewStatus.textContent = 'آماده محاسبه'; previewStatus.className = 'text-light opacity-75'; }
            return;
        }
        if (isCalculating) return;
        isCalculating = true;

        if (previewStatus) { previewStatus.textContent = 'در حال محاسبه...'; previewStatus.className = 'text-warning pulse'; }

        const data = {
            filament_used_mm: parseFloat(filamentUsed.value),
            print_time_hours: parseFloat(printTime.value),
            size_x: parseFloat(sizeX.value),
            size_y: parseFloat(sizeY.value),
            size_z: parseFloat(sizeZ.value),
            filament_cost_per_kg: filamentCostPerKg,
            post_processing_enabled: !!(postProcessing && postProcessing.checked),
            painting_enabled: !!(painting && painting.checked),
            packaging_cost: 0
        };

        fetch('{% url "calculator:calculate_preview" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(d => {
            if (d.error) throw new Error(d.error);

            // Show section
            costPreview.classList.remove('d-none');
            emptyState.classList.add('d-none');

            setText('filament-weight', fmt(d.filament_weight) + ' گرم');
            setText('material-cost', fmt(d.material_cost) + ' تومان');
            setText('electricity-cost', fmt(d.electricity_cost) + ' تومان');
            setText('depreciation-cost', fmt(d.depreciation_cost) + ' تومان');
            setText('total-cost', fmt(d.total_cost) + ' تومان');
            setText('selling-price', fmt(d.selling_price) + ' تومان');

            toggleRow('post-processing-row', d.post_processing_cost > 0, 'post-processing-cost', d.post_processing_cost);
            toggleRow('painting-row', d.painting_cost > 0, 'painting-cost', d.painting_cost);

            const profit = (d.selling_price || 0) - (d.total_cost || 0);
            setText('profit-margin', 'سود: ' + fmt(profit) + ' تومان');

            if (previewStatus) { previewStatus.textContent = 'محاسبه شد ✅'; previewStatus.className = 'text-success'; }
        })
        .catch(err => {
            if (previewStatus) { previewStatus.textContent = 'خطا در محاسبه'; previewStatus.className = 'text-danger'; }
            console.error(err);
        })
        .finally(() => { isCalculating = false; });
    }

    function setText(id, val) {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    }

    function toggleRow(rowId, show, valueId, value) {
        const row = document.getElementById(rowId);
        if (!row) return;
        if (show) {
            row.classList.remove('d-none');
            const el = document.getElementById(valueId);
            if (el) el.textContent = fmt(value) + ' تومان';
            row.classList.add('glow-once');
            setTimeout(() => row.classList.remove('glow-once'), 600);
        } else {
            row.classList.add('d-none');
        }
    }

    // Debounce
    function debounce(fn, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }
    const debounced = debounce(updateCalculationPreview, 300);

    [filamentUsed, printTime, sizeX, sizeY, sizeZ].forEach(el => {
        if (!el) return;
        el.addEventListener('input', debounced);
        el.addEventListener('blur', updateCalculationPreview);
    });

    if (postProcessing) postProcessing.addEventListener('change', () => setTimeout(updateCalculationPreview, 10));
    if (painting) painting.addEventListener('change', () => setTimeout(updateCalculationPreview, 10));

    // Initial calculation
    setTimeout(updateCalculationPreview, 500);

    // Form submission handling
    document.getElementById('projectForm').addEventListener('submit', function(e) {
        if (isCalculating) {
            e.preventDefault();
            alert('لطفاً منتظر تکمیل محاسبات باشید');
            return;
        }
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال بروزرسانی...';
    });
});
</script>

<!-- Include the same CSS from add_project.html -->
<style>
/* Cost Card Styling */
.cost-card-modern {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid var(--secondary-200);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
    overflow: hidden;
}

/* Calculation Grid */
.calculation-grid {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
}

.calc-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--surface-50);
    border: 1px solid var(--secondary-200);
    border-radius: var(--border-radius-md);
    transition: all 0.3s ease;
}

.calc-item:hover {
    background: var(--primary-50);
    border-color: var(--primary-300);
    transform: translateX(2px);
}

.calc-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--border-radius-sm);
    background: var(--primary-100);
    color: var(--primary-600);
    font-size: 0.9rem;
}

.calc-icon.bg-success { background: var(--success-100); color: var(--success-600); }
.calc-icon.bg-warning { background: var(--warning-100); color: var(--warning-600); }
.calc-icon.bg-secondary { background: var(--secondary-100); color: var(--secondary-600); }
.calc-icon.bg-info { background: var(--info-100); color: var(--info-600); }
.calc-icon.bg-danger { background: var(--danger-100); color: var(--danger-600); }

.calc-details {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.calc-label {
    font-size: 0.85rem;
    color: var(--secondary-600);
    margin-bottom: 0.25rem;
}

.calc-value {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--secondary-800);
}

/* Total Section */
.total-section { margin: 1rem 0; }

/* Pricing Highlight */
.pricing-highlight-modern {
    background: linear-gradient(135deg, var(--success-500), var(--success-600));
    border-radius: var(--border-radius-lg);
    color: white;
    padding: 1rem;
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
}

.pricing-highlight-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, transparent, rgba(255,255,255,0.1));
    pointer-events: none;
}

.pricing-highlight-modern > * {
    position: relative;
    z-index: 1;
}

.label-modern {
    font-weight: 600;
    font-size: 0.9rem;
    opacity: 0.95;
}

.profit-text {
    opacity: 0.8;
    font-size: 0.8rem;
}

.price-modern {
    font-size: 1.25rem;
    font-weight: 800;
}

/* Empty State */
.empty-state-modern {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--secondary-500);
}

.empty-icon-modern {
    font-size: 2.5rem;
    color: var(--secondary-400);
    margin-bottom: 0.75rem;
}

.empty-text-modern {
    font-size: 0.9rem;
    color: var(--secondary-600);
}

/* Info Grid Styling */
.info-grid {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: var(--surface-50);
    border: 1px solid var(--secondary-200);
    border-radius: var(--border-radius-md);
    transition: all 0.3s ease;
}

.info-item:hover {
    background: var(--primary-50);
    border-color: var(--primary-300);
    transform: translateX(2px);
}

.info-icon {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--border-radius-sm);
    color: white;
    font-size: 0.9rem;
}

.info-icon.bg-primary { background: var(--primary-500); }
.info-icon.bg-success { background: var(--success-500); }
.info-icon.bg-info { background: var(--info-500); }

.info-details {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.info-label {
    font-size: 0.85rem;
    color: var(--secondary-600);
    margin-bottom: 0.25rem;
}

.info-value {
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--secondary-800);
}

/* Glow Animation */
.glow-once { animation: glow 0.6s ease; }
@keyframes glow {
    0% { box-shadow: 0 0 0 rgba(34, 197, 94, 0); border-color: var(--secondary-200); }
    50% { box-shadow: 0 0 15px rgba(34, 197, 94, 0.3); border-color: var(--success-400); }
    100% { box-shadow: 0 0 0 rgba(34, 197, 94, 0); border-color: var(--secondary-200); }
}

/* Pulse Animation */
.pulse { animation: pulse 1.4s ease-in-out infinite alternate; }
@keyframes pulse { from { opacity: 1; } to { opacity: 0.7; } }

/* Responsive */
@media (max-width: 991.98px) {
    .sticky-top { position: static !important; top: auto !important; }
    .calc-item { padding: 0.5rem; gap: 0.5rem; }
    .calc-icon { width: 32px; height: 32px; font-size: 0.8rem; }
    .pricing-highlight-modern { padding: 0.75rem; }
    .price-modern { font-size: 1.1rem; }
}
</style>
{% endblock %}