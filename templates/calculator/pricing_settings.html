<!-- templates/calculator/pricing_settings.html -->
{% extends "calculator/base.html" %}
{% block title %}تنظیمات قیمت‌گذاری{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-md-4">
  <!-- Modern Hero Section -->
  <div class="modern-hero-card mb-4">
    <div class="hero-background"></div>
    <div class="hero-content">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-2">
          <span class="hero-icon-modern"><i class="fas fa-sliders-h"></i></span>
          <div>
            <h1 class="hero-title-modern mb-0">تنظیمات قیمت‌گذاری</h1>
            <div class="hero-subtitle-modern mt-1">قیمت برق، درصد سود، استهلاک و سرویس‌ها را مدیریت کنید</div>
          </div>
        </div>
        <div class="text-muted small">
          آخرین بروزرسانی: {{ settings_obj.updated_at|date:"Y/m/d H:i" }}
        </div>
      </div>
    </div>
  </div>

  <form method="post" class="row g-4" novalidate>
    {% csrf_token %}

    <div class="col-12 col-xl-8">
      <!-- Base Costs Section -->
      <div class="card modern-card">
        <div class="card-header border-0">
          <div class="d-flex align-items-center gap-2">
            <span class="setting-icon bg-warning">
              <i class="fas fa-bolt"></i>
            </span>
            <h5 class="mb-0">هزینه‌های پایه</h5>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-bolt me-2 text-warning"></i>قیمت برق (تومان/کیلووات‌ساعت)
              </label>
              {{ form.power_price_per_kwh }}
              {% for e in form.power_price_per_kwh.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              <div class="form-text">قیمت هر کیلووات‌ساعت برق مصرفی</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-tools me-2 text-secondary"></i>استهلاک دستگاه (تومان/ساعت)
              </label>
              {{ form.depreciation_per_hour }}
              {% for e in form.depreciation_per_hour.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              <div class="form-text">هزینه استهلاک دستگاه در هر ساعت</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-percent me-2 text-info"></i>درصد پرت فیلامنت (%)
              </label>
              {{ form.filament_waste_percent }}
              {% for e in form.filament_waste_percent.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              <div class="form-text">درصد فیلامنت هدر رفته در فرآیند</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-box me-2 text-primary"></i>هزینه بسته‌بندی (تومان)
              </label>
              {{ form.packaging_cost }}
              {% for e in form.packaging_cost.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              <div class="form-text">هزینه پیش‌فرض بسته‌بندی</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Services Section -->
      <div class="card modern-card mt-4">
        <div class="card-header border-0">
          <div class="d-flex align-items-center gap-2">
            <span class="setting-icon bg-info">
              <i class="fas fa-tools"></i>
            </span>
            <h5 class="mb-0">خدمات اضافی</h5>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-hammer me-2 text-info"></i>نرخ پست‌پروسسینگ (تومان)
              </label>
              {{ form.post_processing_rate }}
              {% for e in form.post_processing_rate.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              <div class="form-text">هزینه پرداخت و تمیزکاری</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-palette me-2 text-danger"></i>نرخ رنگ‌آمیزی (تومان/سانتی‌متر مربع)
              </label>
              {{ form.painting_rate_per_cm2 }}
              {% for e in form.painting_rate_per_cm2.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              <div class="form-text">قیمت رنگ‌آمیزی هر سانتی‌متر مربع</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing Policy Section -->
      <div class="card modern-card mt-4">
        <div class="card-header border-0">
          <div class="d-flex align-items-center gap-2">
            <span class="setting-icon bg-success">
              <i class="fas fa-percentage"></i>
            </span>
            <h5 class="mb-0">سیاست قیمت‌گذاری</h5>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-chart-line me-2 text-success"></i>درصد سود (%)
              </label>
              {{ form.profit_percent }}
              {% for e in form.profit_percent.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              <div class="form-text">درصد سود اضافه شده به هزینه‌ها</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">
                <i class="fas fa-calculator me-2 text-secondary"></i>گرد کردن قیمت (تومان)
              </label>
              {{ form.round_to_nearest }}
              {% for e in form.round_to_nearest.errors %}<div class="text-danger small mt-1">{{ e }}</div>{% endfor %}
              <div class="form-text">قیمت‌ها به این مقدار گرد می‌شوند</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Action Section - UPDATED (No Checkbox) -->
      <div class="card modern-card mt-4" style="background: var(--surface-50);">
        <div class="card-body d-flex align-items-center justify-content-between gap-3 flex-wrap">
          <div class="d-flex align-items-center gap-2">
            <i class="fas fa-info-circle text-info"></i>
            <span class="text-muted">این تنظیمات بر تمام محاسبات آینده تأثیر خواهد گذاشت</span>
          </div>
          <div class="d-flex gap-2 ms-auto">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save me-1"></i> ذخیره تنظیمات
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Preview Sidebar -->
    <div class="col-12 col-xl-4">
      <div class="sticky-top" style="top: 90px;">
        <div class="card modern-card">
          <div class="card-header border-0">
            <h6 class="mb-0"><i class="fas fa-eye me-2"></i>پیش‌نمایش تنظیمات</h6>
          </div>
          <div class="card-body">
            <div class="settings-preview">
              <div class="preview-section">
                <h6 class="text-warning mb-3">
                  <i class="fas fa-bolt me-2"></i>هزینه‌های پایه
                </h6>
                <div class="preview-grid">
                  <div class="preview-item">
                    <span class="preview-label">قیمت برق</span>
                    <strong class="preview-value">{{ form.power_price_per_kwh.value|default:settings_obj.power_price_per_kwh }} ت</strong>
                  </div>
                  <div class="preview-item">
                    <span class="preview-label">استهلاک</span>
                    <strong class="preview-value">{{ form.depreciation_per_hour.value|default:settings_obj.depreciation_per_hour }} ت/س</strong>
                  </div>
                  <div class="preview-item">
                    <span class="preview-label">بسته‌بندی</span>
                    <strong class="preview-value">{{ form.packaging_cost.value|default:settings_obj.packaging_cost }} ت</strong>
                  </div>
                </div>
              </div>

              <div class="preview-section">
                <h6 class="text-info mb-3">
                  <i class="fas fa-tools me-2"></i>خدمات
                </h6>
                <div class="preview-grid">
                  <div class="preview-item">
                    <span class="preview-label">پست‌پروسسینگ</span>
                    <strong class="preview-value">{{ form.post_processing_rate.value|default:settings_obj.post_processing_rate }} ت</strong>
                  </div>
                  <div class="preview-item">
                    <span class="preview-label">رنگ‌آمیزی</span>
                    <strong class="preview-value">{{ form.painting_rate_per_cm2.value|default:settings_obj.painting_rate_per_cm2 }} ت/سم²</strong>
                  </div>
                </div>
              </div>

              <div class="preview-section">
                <h6 class="text-success mb-3">
                  <i class="fas fa-percentage me-2"></i>سیاست قیمت
                </h6>
                <div class="preview-grid">
                  <div class="preview-item">
                    <span class="preview-label">درصد سود</span>
                    <strong class="preview-value text-success">{{ form.profit_percent.value|default:settings_obj.profit_percent }}%</strong>
                  </div>
                  <div class="preview-item">
                    <span class="preview-label">گرد کردن</span>
                    <strong class="preview-value">{{ form.round_to_nearest.value|default:settings_obj.round_to_nearest }} ت</strong>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="alert alert-info mt-3 mb-0" style="background: var(--info-50); border: 1px solid var(--info-200); color: var(--info-800);">
              <i class="fas fa-info-circle me-2"></i>
              این تنظیمات در محاسبات صفحه افزودن مدل به صورت زنده استفاده می‌شود.
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Modern Hero */
.modern-hero-card {
  position: relative;
  border-radius: var(--border-radius-xl);
  overflow: hidden;
  padding: var(--spacing-xl);
  background: rgba(255,255,255,0.7);
  backdrop-filter: blur(20px);
  border: 1px solid var(--primary-200);
  box-shadow: var(--shadow-lg);
}
.hero-background {
  position: absolute; inset: 0;
  background: radial-gradient(1200px 400px at 100% -10%, var(--success-100), transparent),
              radial-gradient(600px 300px at -10% 120%, var(--primary-100), transparent);
  pointer-events: none;
}
.hero-content { position: relative; z-index: 1; }
.hero-icon-modern {
  display: inline-flex; width: 40px; height: 40px;
  border-radius: var(--border-radius-md); align-items: center; justify-content: center;
  background: linear-gradient(135deg, var(--primary-500), var(--success-500)); 
  color: #fff;
  box-shadow: var(--shadow-md);
}
.hero-title-modern { font-size: 1.4rem; font-weight: 800; color: var(--secondary-800); }
.hero-subtitle-modern { color: var(--secondary-600); font-size: .95rem; }

/* Modern Cards */
.modern-card {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(20px);
  border: 1px solid var(--primary-200);
  border-radius: var(--border-radius-xl);
  box-shadow: var(--shadow-lg);
  overflow: hidden;
}

/* Setting Icons */
.setting-icon {
  width: 32px;
  height: 32px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--border-radius-sm);
  color: white;
  font-size: 0.9rem;
}

.setting-icon.bg-warning { background: var(--warning-500); }
.setting-icon.bg-info { background: var(--info-500); }
.setting-icon.bg-success { background: var(--success-500); }

/* Preview Styling */
.settings-preview {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.preview-section {
  padding: 1rem;
  background: var(--surface-50);
  border: 1px solid var(--secondary-200);
  border-radius: var(--border-radius-lg);
}

.preview-grid {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.preview-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--secondary-200);
}

.preview-item:last-child {
  border-bottom: none;
}

.preview-label {
  font-size: 0.85rem;
  color: var(--secondary-600);
  flex: 1;
}

.preview-value {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--secondary-800);
}

/* Responsive */
@media (max-width: 991.98px) {
  .hero-title-modern { font-size: 1.2rem; }
  .sticky-top { position: static !important; top: auto !important; }
}
</style>
{% endblock %}