{% extends "calculator/base.html" %}
{% load querystring %}
{% block title %}فهرست مدل‌ها{% endblock %}

{% block content %}
<div class="page-header">
  <div class="container">
    <h1 class="page-title">
      <i class="fas fa-project-diagram me-3"></i>
      فهرست مدل‌ها
    </h1>
    <p class="page-subtitle">مرور، جستجو، فیلتر، مرتب‌سازی و مدیریت کامل مدل‌ها</p>
  </div>
</div>

<div class="container">
  <!-- Filters and Actions -->
  <div class="card fade-in mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label"><i class="fas fa-search me-2"></i>جستجو</label>
          <input type="text" name="q" class="form-control" placeholder="نام مدل، کد، نام/رنگ فیلامنت..."
                 value="{{ q }}">
        </div>
        <div class="col-md-3">
          <label class="form-label"><i class="fas fa-atom me-2"></i>نوع ماده</label>
          <select name="material" class="form-select">
            <option value="">همه</option>
            {% for val,label in materials %}
              <option value="{{ val }}" {% if material == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label"><i class="fas fa-layer-group me-2"></i>فیلامنت</label>
          <select name="filament" class="form-select">
            <option value="">همه</option>
            {% for f in filaments %}
              <option value="{{ f.id }}" {% if filament_id|default:''|stringformat:'s' == f.id|stringformat:'s' %}selected{% endif %}>
                {{ f.name }} - {{ f.color }}
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label"><i class="fas fa-sort me-2"></i>مرتب‌سازی</label>
          <select name="sort" class="form-select">
            <option value="-created_date" {% if sort == "-created_date" %}selected{% endif %}>جدیدترین</option>
            <option value="created_date" {% if sort == "created_date" %}selected{% endif %}>قدیمی‌ترین</option>
            <option value="-selling_price" {% if sort == "-selling_price" %}selected{% endif %}>گران‌ترین</option>
            <option value="selling_price" {% if sort == "selling_price" %}selected{% endif %}>ارزان‌ترین</option>
            <option value="-profit" {% if sort == "-profit" %}selected{% endif %}>بیشترین سود</option>
            <option value="profit" {% if sort == "profit" %}selected{% endif %}>کمترین سود</option>
            <option value="-print_time_hours" {% if sort == "-print_time_hours" %}selected{% endif %}>زمان پرینت (بیشتر)</option>
            <option value="print_time_hours" {% if sort == "print_time_hours" %}selected{% endif %}>زمان پرینت (کمتر)</option>
            <option value="code" {% if sort == "code" %}selected{% endif %}>کد صعودی</option>
            <option value="-code" {% if sort == "-code" %}selected{% endif %}>کد نزولی</option>
          </select>
        </div>

        <div class="col-md-12 d-flex justify-content-between mt-2">
          <div>
            <input type="hidden" name="view" id="viewInput" value="{{ view_mode }}">
            <button type="submit" class="btn btn-primary me-2">
              <i class="fas fa-filter me-2"></i>اعمال
            </button>
            <a href="{% url 'calculator:projects' %}" class="btn btn-outline-secondary">
              <i class="fas fa-undo me-2"></i>بازنشانی
            </a>
          </div>
          <div class="btn-group">
            <a href="?{% querystring q=q material=material filament=filament_id sort=sort view='cards' %}"
               class="btn {% if view_mode == 'cards' %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-th-large"></i>
            </a>
            <a href="?{% querystring q=q material=material filament=filament_id sort=sort view='table' %}"
               class="btn {% if view_mode == 'table' %}btn-primary{% else %}btn-outline-primary{% endif %}">
              <i class="fas fa-list"></i>
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Results header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="text-muted">
      <i class="fas fa-database me-1"></i>
      {{ total_count }} نتیجه
    </div>
    <a class="btn btn-success" href="{% url 'calculator:index' %}">
      <i class="fas fa-plus me-2"></i>افزودن مدل جدید
    </a>
  </div>

  {% if page_obj.object_list %}
    {% if view_mode == 'table' %}
      <!-- Table view -->
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>کد</th>
                  <th>تصویر</th>
                  <th>نام مدل</th>
                  <th>فیلامنت</th>
                  <th>وزن(گرم)</th>
                  <th>زمان(س)</th>
                  <th>ابعاد (X×Y×Z)</th>
                  <th>هزینه</th>
                  <th>قیمت</th>
                  <th>سود</th>
                  <th>تاریخ</th>
                  <th>اقدامات</th>
                </tr>
              </thead>
              <tbody>
                {% for p in page_obj.object_list %}
                <tr>
                  <td><span class="badge bg-secondary">{{ p.code }}</span></td>
                  <td>
                    {% if p.has_image %}
                      <img src="{{ p.picture.url }}" alt="{{ p.model_name }}" class="rounded"
                           style="width:40px;height:40px;object-fit:cover;">
                    {% else %}
                      <div class="bg-light rounded d-flex align-items-center justify-content-center"
                           style="width:40px;height:40px;">
                        <i class="fas fa-cube text-muted"></i>
                      </div>
                    {% endif %}
                  </td>
                  <td>{{ p.model_name }}</td>
                  <td><small class="text-muted">{{ p.filament.name }} - {{ p.filament.color }}</small></td>
                  <td>{{ p.filament_weight_used|floatformat:0 }}</td>
                  <td>{{ p.print_time_hours|floatformat:1 }}</td>
                  <td>{{ p.size_x|floatformat:0 }}×{{ p.size_y|floatformat:0 }}×{{ p.size_z|floatformat:0 }}</td>
                  <td class="text-danger">{{ p.total_cost|floatformat:0 }}</td>
                  <td class="text-success">{{ p.selling_price|floatformat:0 }}</td>
                  <td class="{% if p.profit >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">
                    {{ p.profit|floatformat:0 }}
                  </td>
                  <td><small class="text-muted">{{ p.created_date|date:"Y/m/d H:i" }}</small></td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <a class="btn btn-success" href="{% url 'calculator:sales' %}?code={{ p.code }}"><i class="fas fa-shopping-cart"></i></a>
                      <a class="btn btn-outline-primary" href="{% url 'calculator:edit_project' p.pk %}"><i class="fas fa-edit"></i></a>
                      <a class="btn btn-outline-danger" href="{% url 'calculator:delete_project' p.pk %}" onclick="return confirm('حذف شود؟');"><i class="fas fa-trash"></i></a>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          {% include "calculator/partials/pagination.html" with page_obj=page_obj %}
        </div>
      </div>
    {% else %}
      <!-- Cards view -->
      <div class="row">
        {% for p in page_obj.object_list %}
        <div class="col-lg-6 col-xl-4 mb-4">
          <div class="card h-100">
            <div class="card-body p-3">
              <div class="mb-3 text-center">
                {% if p.has_image %}
                  <img src="{{ p.picture.url }}" alt="{{ p.model_name }}" class="img-fluid rounded project-image"
                       style="height:140px;width:100%;object-fit:cover;">
                {% else %}
                  <div class="image-placeholder" style="height:140px;">
                    <i class="fas fa-cube fa-3x"></i>
                  </div>
                {% endif %}
              </div>

              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="text-primary mb-0">{{ p.model_name }}</h6>
                <span class="badge bg-secondary">{{ p.code }}</span>
              </div>

              <p class="text-muted mb-2"><small>{{ p.filament.name }} - {{ p.filament.color }} | {{ p.filament.material }}</small></p>

              <div class="row text-center mb-2">
                <div class="col-4">
                  <small class="text-muted">وزن</small><br><strong>{{ p.filament_weight_used|floatformat:0 }}گ</strong>
                </div>
                <div class="col-4">
                  <small class="text-muted">زمان</small><br><strong>{{ p.print_time_hours|floatformat:1 }}س</strong>
                </div>
                <div class="col-4">
                  <small class="text-muted">ابعاد</small><br>
                  <strong>{{ p.size_x|floatformat:0 }}×{{ p.size_y|floatformat:0 }}×{{ p.size_z|floatformat:0 }}</strong>
                </div>
              </div>

              <div class="cost-preview">
                <div class="cost-item">
                  <span><small>هزینه:</small></span>
                  <span class="text-danger fw-bold">{{ p.total_cost|floatformat:0 }}</span>
                </div>
                <div class="cost-item">
                  <span><small>قیمت:</small></span>
                  <span class="text-success fw-bold">{{ p.selling_price|floatformat:0 }}</span>
                </div>
                <div class="cost-item">
                  <span><small>سود:</small></span>
                  <span class="{% if p.profit >= 0 %}text-success{% else %}text-danger{% endif %} fw-bold">{{ p.profit|floatformat:0 }}</span>
                </div>
              </div>

              <div class="d-flex gap-2 mt-3">
                <a href="{% url 'calculator:sales' %}?code={{ p.code }}" class="btn btn-success btn-sm flex-fill">
                  <i class="fas fa-shopping-cart me-1"></i>فروش
                </a>
                <a href="{% url 'calculator:edit_project' p.pk %}" class="btn btn-outline-primary btn-sm">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="{% url 'calculator:delete_project' p.pk %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('آیا مطمئن هستید؟')">
                  <i class="fas fa-trash"></i>
                </a>
              </div>

              <div class="d-flex justify-content-between mt-2">
                <small class="text-muted"><i class="fas fa-clock me-1"></i>{{ p.created_date|date:"Y/m/d H:i" }}</small>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      {% include "calculator/partials/pagination.html" with page_obj=page_obj %}
    {% endif %}
  {% else %}
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">مدل‌ای یافت نشد</h5>
        <p class="text-muted">فیلترها را تغییر دهید یا مدل جدیدی ثبت کنید</p>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Smooth card appear
document.addEventListener('DOMContentLoaded', function() {
  const cards = document.querySelectorAll('.col-lg-6, .col-xl-4');
  cards.forEach((c, i) => {
    c.style.opacity = '0';
    c.style.transform = 'translateY(20px)';
    setTimeout(() => {
      c.style.transition = 'all .4s ease';
      c.style.opacity = '1';
      c.style.transform = 'translateY(0)';
    }, i * 60);
  });
});
</script>
{% endblock %}